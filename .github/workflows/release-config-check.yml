# Validate release configuration on PRs
# Catches GoReleaser and Dockerfile issues before merge

name: Release Config Check

on:
  pull_request:
    branches: [main]
    paths:
      - '.goreleaser.yml'
      - 'Dockerfile'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-config-check.yml'
  push:
    branches: [main]
    paths:
      - '.goreleaser.yml'
      - 'Dockerfile'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-config-check.yml'

permissions:
  contents: read

jobs:
  goreleaser-check:
    name: Validate GoReleaser Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Validate GoReleaser config
        id: goreleaser-check
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: check
        continue-on-error: true

      - name: Check for real errors vs deprecation warnings
        env:
          CHECK_OUTCOME: ${{ steps.goreleaser-check.outcome }}
        run: |
          # If check passed, we're done
          if [ "$CHECK_OUTCOME" = "success" ]; then
            echo "GoReleaser config is valid"
            exit 0
          fi

          # Run check again to capture output
          output=$(goreleaser check 2>&1) || true

          # If the only issue is deprecation warnings, treat as success
          if echo "$output" | grep -q "configuration is valid, but uses deprecated properties"; then
            echo "::warning::GoReleaser config uses deprecated properties (brews/dockers will be phased out in future versions)"
            echo "$output"
            exit 0
          fi

          # Otherwise, it's a real error
          echo "::error::GoReleaser config has errors"
          echo "$output"
          exit 1

  goreleaser-snapshot:
    name: Test GoReleaser Snapshot Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Run GoReleaser Snapshot
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean --skip=docker,publish

      - name: Verify artifacts created
        run: |
          echo "Checking dist/ for expected artifacts..."
          ls -la dist/

          # Verify binaries exist
          test -f dist/dsops_linux_amd64_v1/dsops || (echo "Missing linux/amd64 binary" && exit 1)
          test -f dist/dsops_darwin_arm64_v8.0/dsops || (echo "Missing darwin/arm64 binary" && exit 1)

          # Verify archives exist
          ls dist/*.tar.gz || (echo "Missing tar.gz archives" && exit 1)
          ls dist/*.zip || (echo "Missing zip archives" && exit 1)

          # Verify checksums exist
          ls dist/*checksums.txt || (echo "Missing checksums file" && exit 1)

          echo "All expected artifacts found!"

  docker-build-check:
    name: Validate Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image (validation only)
        run: |
          docker build --target builder -t dsops:build-check .
          echo "Docker build validation successful"

  docker-multiplatform-check:
    name: Validate Multi-Platform Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build multi-platform image (no push)
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-arg VERSION=test \
            .
          echo "Multi-platform Docker build validation successful"

  goreleaser-docker-check:
    name: Validate GoReleaser Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run GoReleaser Snapshot with Docker
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean --skip=publish

      - name: Verify Docker images created
        run: |
          echo "Checking for Docker image artifacts..."
          ls -la dist/ | grep -E "docker|image" || true
          echo "GoReleaser Docker build validation successful"

  homebrew-cask-audit:
    name: Audit Generated Homebrew Cask
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Generate cask with GoReleaser snapshot
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean --skip=publish,docker

      - name: Verify cask was generated
        run: |
          echo "Checking for generated cask..."
          ls -la dist/homebrew/Casks/
          test -f dist/homebrew/Casks/dsops.rb || (echo "Cask not generated" && exit 1)
          echo "Generated cask contents:"
          cat dist/homebrew/Casks/dsops.rb

      - name: Audit generated cask
        run: |
          # Create a local tap with the generated cask
          # (brew audit requires a tap name, not a file path)
          TAP_PATH="$(brew --repository)/Library/Taps/local/homebrew-dsops-test"
          mkdir -p "$TAP_PATH/Casks"
          cp dist/homebrew/Casks/dsops.rb "$TAP_PATH/Casks/"

          # Run brew audit on the cask by tap name
          # Skip checks that fail for snapshot builds (URLs don't exist yet)
          brew audit --cask "local/dsops-test/dsops" \
            --except=cask_checksum_mismatch \
            --except=cask_download_url_not_found \
            --except=cask_download_url
          echo "Homebrew cask audit passed!"
