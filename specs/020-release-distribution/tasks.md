# Tasks: Release & Distribution Infrastructure

**Input**: Design documents from `/specs/020-release-distribution/`
**Prerequisites**: plan.md (required), spec.md (required), research.md, data-model.md, contracts/

**Tests**: Not included - this is DevOps/infrastructure work with manual validation

**Organization**: Tasks grouped by user story for independent implementation

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (US1-US6)
- Include exact file paths in descriptions

## Path Conventions

This feature adds files at repository root:
- `.goreleaser.yml` - Release configuration
- `Dockerfile` - Container image
- `.github/workflows/release.yml` - Release automation

External repository:
- `systmms/homebrew-tap` - Homebrew tap (separate GitHub repo)

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project preparation and prerequisites

- [x] T001 Create completions directory at repository root: `mkdir -p completions`
- [x] T002 [P] Verify Makefile LDFLAGS work with manual build: `make build && ./bin/dsops --version`
- [x] T003 [P] Verify existing CI workflow passes on main branch

**Checkpoint**: Project ready for release infrastructure

---

## Phase 2: Foundational - Automated Release on Version Tag (US5, Priority: P1) üéØ MVP

**Goal**: Enable maintainers to release by pushing a version tag

**Independent Test**: Push `v0.0.1-test.1` tag and verify workflow triggers

**‚ö†Ô∏è CRITICAL**: This phase MUST complete before US1, US2, US3 can be tested

### Implementation for US5

- [x] T004 [US5] Create GoReleaser configuration at `.goreleaser.yml` with:
  - Project name: dsops
  - Builds for 5 platform/arch combinations (darwin-arm64, darwin-amd64, linux-amd64, linux-arm64, windows-amd64)
  - LDFLAGS for version embedding: `-X main.version={{.Version}} -X main.commit={{.ShortCommit}} -X main.date={{.Date}}`
  - CGO_ENABLED=0 for static binaries
  - See contracts/goreleaser.yaml for reference

- [x] T005 [US5] Configure archive settings in `.goreleaser.yml`:
  - Format: tar.gz for Unix, zip for Windows
  - Name template: `dsops_{{.Version}}_{{.Os}}_{{.Arch}}`
  - Include: LICENSE, README.md, completions/*

- [x] T006 [US5] Configure changelog generation in `.goreleaser.yml`:
  - Use GitHub for changelog source
  - Group by: feat, fix, perf
  - Exclude: docs, test, ci, chore commits

- [x] T007 [US5] Configure checksum generation in `.goreleaser.yml`:
  - Algorithm: sha256
  - Name template: `dsops_{{.Version}}_checksums.txt`

- [x] T008 [US5] Create GitHub Actions release workflow at `.github/workflows/release.yml`:
  - Trigger: push tags matching `v*`
  - Permissions: contents:write, packages:write
  - Job 1: Run tests (fail-fast before release)
  - Job 2: Run GoReleaser with GITHUB_TOKEN

- [x] T009 [US5] Add shell completion generation hooks to `.goreleaser.yml`:
  - Post-build hook: generate bash completion to completions/dsops.bash
  - Post-build hook: generate zsh completion to completions/dsops.zsh
  - Post-build hook: generate fish completion to completions/dsops.fish

- [x] T010 [US5] Test GoReleaser locally with dry-run: `goreleaser release --snapshot --clean`

**Checkpoint**: Push a test tag (v0.0.1-test.1) and verify workflow runs. Binaries should appear in GitHub Releases.

---

## Phase 3: Pre-built Binary Distribution (US2, Priority: P1)

**Goal**: Enable users to download pre-built binaries from GitHub Releases

**Independent Test**: Download archive from Releases, extract, run `./dsops --version`

**Note**: Most of US2 is already satisfied by US5 (GoReleaser creates the releases)

### Implementation for US2

- [x] T011 [US2] Verify release archives contain correct files:
  - dsops binary (executable)
  - LICENSE file
  - README.md file
  - completions/ directory with bash, zsh, fish scripts

- [x] T012 [US2] Test binary download and execution on macOS:
  ```bash
  curl -L <release-url>/dsops_<version>_darwin_arm64.tar.gz -o dsops.tar.gz
  tar -xzf dsops.tar.gz
  ./dsops --version
  ```

- [x] T013 [P] [US2] Test binary download and execution on Linux (via Docker):
  ```bash
  docker run --rm -v $(pwd):/work ubuntu:22.04 bash -c "
    curl -L <release-url>/dsops_<version>_linux_amd64.tar.gz -o dsops.tar.gz
    tar -xzf dsops.tar.gz
    ./dsops --version
  "
  ```

**Checkpoint**: Binaries downloadable and executable on all platforms

---

## Phase 4: Checksum Verification (US6, Priority: P3)

**Goal**: Enable security-conscious users to verify binary integrity

**Independent Test**: Download checksums file, verify with `sha256sum -c`

**Note**: Checksums are auto-generated by GoReleaser (T007)

### Implementation for US6

- [x] T014 [US6] Verify checksums file is published with release:
  - Check GitHub Release contains `dsops_<version>_checksums.txt`
  - Verify format is compatible with sha256sum

- [x] T015 [US6] Test checksum verification:
  ```bash
  curl -LO <release-url>/dsops_<version>_darwin_arm64.tar.gz
  curl -LO <release-url>/dsops_<version>_checksums.txt
  sha256sum -c dsops_<version>_checksums.txt --ignore-missing
  ```

**Checkpoint**: Checksum verification works for all platform archives

---

## Phase 5: Docker Distribution (US3, Priority: P2)

**Goal**: Enable running dsops in containers via ghcr.io

**Independent Test**: `docker run --rm ghcr.io/systmms/dsops:latest --version`

### Implementation for US3

- [x] T016 [US3] Create multi-stage Dockerfile at repository root:
  - Stage 1 (builder): golang:1.25-alpine, build static binary
  - Stage 2 (runtime): gcr.io/distroless/static-debian12:nonroot
  - Copy CA certificates from builder
  - Set WORKDIR=/work for volume mounts
  - Set ENTRYPOINT to dsops binary
  - Add OCI labels (version, source, licenses)
  - See contracts/Dockerfile for reference

- [x] T017 [US3] Test Docker build locally:
  ```bash
  docker build -t dsops:local .
  docker run --rm dsops:local --version
  docker images dsops:local --format "{{.Size}}"  # Verify under 50MB
  ```

- [x] T018 [US3] Add Docker login step to release workflow in `.github/workflows/release.yml`:
  - Use docker/login-action@v3
  - Registry: ghcr.io
  - Username: github.actor
  - Password: secrets.GITHUB_TOKEN

- [x] T019 [US3] Add Docker publishing to GoReleaser in `.goreleaser.yml`:
  - Image templates: ghcr.io/systmms/dsops:{{.Version}}, ghcr.io/systmms/dsops:latest
  - Reference Dockerfile at repository root
  - Add OCI labels via build_flag_templates
  - Skip :latest for pre-releases (skip_push: auto)

- [x] T020 [US3] Add verification job to release workflow:
  - Pull published image
  - Run `--version` to verify
  - Check image size is under 50MB

**Checkpoint**: `docker pull ghcr.io/systmms/dsops:<version>` and run works

---

## Phase 6: Homebrew Distribution (US1, Priority: P1)

**Goal**: Enable `brew install systmms/tap/dsops` on macOS and Linux

**Independent Test**: `brew install systmms/tap/dsops && dsops --version`

### Implementation for US1

- [x] T021 [US1] Create Homebrew tap repository `systmms/homebrew-tap` on GitHub:
  - Initialize with README.md explaining the tap
  - Create Formula/ directory
  - Set repository to public

- [x] T022 [US1] Create initial Homebrew formula at `systmms/homebrew-tap/Formula/dsops.rb`:
  - Use template from data-model.md
  - Set homepage, description, license
  - Install binary to bin/
  - Install completions to correct locations
  - Add test block: `system "#{bin}/dsops", "--version"`

- [x] T023 [US1] Create Personal Access Token (PAT) for cross-repo access:
  - Scope: repo (for systmms/homebrew-tap)
  - Store as repository secret: HOMEBREW_TAP_GITHUB_TOKEN

- [x] T024 [US1] Add Homebrew tap configuration to `.goreleaser.yml`:
  - Repository: systmms/homebrew-tap
  - Folder: Formula
  - Token: `{{ .Env.HOMEBREW_TAP_GITHUB_TOKEN }}`
  - Skip for pre-releases (skip_upload: auto)
  - Install block with completion scripts

- [x] T025 [US1] Update release workflow to pass HOMEBREW_TAP_GITHUB_TOKEN to GoReleaser

- [x] T026 [US1] Test Homebrew installation after release (tested via nix-darwin cask):
  ```bash
  brew tap systmms/tap
  brew install dsops
  dsops --version
  brew uninstall dsops
  brew untap systmms/tap
  ```

**Checkpoint**: `brew install systmms/tap/dsops` works on macOS

---

## Phase 7: go install Verification (US4, Priority: P2)

**Goal**: Enable `go install github.com/systmms/dsops/cmd/dsops@latest`

**Independent Test**: `go install github.com/systmms/dsops/cmd/dsops@latest && dsops --version`

**Note**: This works automatically once the repository is public

### Implementation for US4

- [x] T027 [US4] Verify repository is public on GitHub (prerequisite for go install)

- [x] T028 [US4] Test go install with specific version tag:
  ```bash
  go install github.com/systmms/dsops/cmd/dsops@v0.2.0
  dsops --version
  ```

- [x] T029 [US4] Test go install with @latest:
  ```bash
  go install github.com/systmms/dsops/cmd/dsops@latest
  dsops --version
  ```

**Checkpoint**: go install works with both @latest and @version

---

## Phase 8: Automated Version Management (US7, Priority: P1)

**Goal**: Enable automated version bumping and changelog generation via release-please

**Independent Test**: Merge a commit with `feat:` prefix and verify release-please creates a Release PR

### Implementation for US7

- [x] T037 [US7] Create release-please workflow at `.github/workflows/release-please.yml`:
  - Trigger: push to main branch
  - Uses: googleapis/release-please-action@v4
  - Token: RELEASE_PLEASE_TOKEN secret

- [x] T038 [US7] Create release-please config at `release-please-config.json`:
  - release-type: go
  - bump-minor-pre-major: true (stay on 0.x.x for breaking changes)
  - bump-patch-for-minor-pre-major: true
  - changelog-path: CHANGELOG.md

- [x] T039 [US7] Create release-please manifest at `.release-please-manifest.json`:
  - Initial version: 0.1.0

- [x] T040 [US7] Create RELEASE_PLEASE_TOKEN secret with repo scope for workflow chaining

- [ ] T041 [US7] Test release-please workflow:
  - Push a commit with `fix:` prefix to main
  - Verify Release PR is created with patch bump
  - Merge Release PR
  - Verify tag is created and GoReleaser workflow triggers

**Checkpoint**: Merging a Release PR automatically creates a tag and triggers the full release workflow

---

## Phase 9: Polish & Cross-Cutting Concerns

**Purpose**: Documentation and final validation

- [x] T030 [P] Verify docs/content/getting-started/installation.md matches implemented methods
- [x] T031 [P] Update CONTRIBUTING.md with release process (how to create a release)
- [x] T032 [P] Add developer documentation for release workflow in docs/developer/
- [ ] T036 [P] Add release example in examples/release-workflow.md showing version tagging best practices
- [x] T033 Create first official release (v0.2.0 or appropriate version) - v0.2.3 exists
- [ ] T034 Run full validation from quickstart.md:
  - Test Homebrew install
  - Test binary download
  - Test Docker run
  - Test go install
  - Test checksum verification
- [ ] T035 Update docs/content/reference/status.md to mark SPEC-020 as implemented

---

## Phase 10: macOS Code Signing & Notarization (US8, Priority: P2)

**Goal**: Sign and notarize macOS binaries for seamless Gatekeeper experience

**Independent Test**: Download signed binary and run without `xattr -dr com.apple.quarantine`

### Apple Developer Setup (One-time)

- [ ] T042 [US8] Create Developer ID Application certificate in Apple Developer Portal:
  - Go to https://developer.apple.com ‚Üí Certificates, Identifiers & Profiles
  - Create new certificate: Certificates ‚Üí + ‚Üí Developer ID Application
  - Download .cer file and import into Keychain.app

- [ ] T043 [US8] Export certificate as .p12 file:
  - Open Keychain Access
  - Find certificate, right-click ‚Üí Export
  - Save as .p12 with strong password
  - Note: Must use 2048-bit RSA key

- [ ] T044 [US8] Create App Store Connect API key:
  - Go to https://appstoreconnect.apple.com
  - Users and Access ‚Üí Keys ‚Üí Create new key
  - Role: Developer or App Manager
  - Download .p8 file (only available once!)
  - Note the Key ID and Issuer ID

- [ ] T045 [US8] Add GitHub repository secrets:
  ```bash
  # Encode files as base64
  base64 -i Certificates.p12 | tr -d '\n' | pbcopy  # Copy to clipboard
  base64 -i AuthKey_XXXX.p8 | tr -d '\n' | pbcopy
  ```
  Add these secrets in GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions:
  - `MACOS_SIGN_P12` (base64-encoded .p12)
  - `MACOS_SIGN_PASSWORD` (.p12 password)
  - `MACOS_NOTARY_ISSUER_ID` (UUID from App Store Connect)
  - `MACOS_NOTARY_KEY_ID` (Key ID from App Store Connect)
  - `MACOS_NOTARY_KEY` (base64-encoded .p8)

### GoReleaser Configuration

- [ ] T046 [US8] Add notarize section to `.goreleaser.yml`:
  ```yaml
  notarize:
    macos:
      - enabled: '{{ isEnvSet "MACOS_SIGN_P12" }}'
        sign:
          certificate: "{{ .Env.MACOS_SIGN_P12 }}"
          password: "{{ .Env.MACOS_SIGN_PASSWORD }}"
        notarize:
          issuer_id: "{{ .Env.MACOS_NOTARY_ISSUER_ID }}"
          key_id: "{{ .Env.MACOS_NOTARY_KEY_ID }}"
          key: "{{ .Env.MACOS_NOTARY_KEY }}"
  ```

- [ ] T047 [US8] Update `.github/workflows/release.yml` to pass Apple secrets:
  ```yaml
  env:
    MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12 }}
    MACOS_SIGN_PASSWORD: ${{ secrets.MACOS_SIGN_PASSWORD }}
    MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
    MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
    MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
  ```

- [ ] T048 [US8] Remove quarantine removal hook from homebrew_casks config (no longer needed)

### Validation

- [ ] T049 [US8] Test signed binary on macOS:
  - Download from GitHub Release
  - Run binary directly (no xattr command needed)
  - Verify no Gatekeeper warning appears

- [ ] T050 [US8] Verify notarization with Apple:
  ```bash
  spctl -a -vv ./dsops
  # Expected output: source=Notarized Developer ID
  ```

**Checkpoint**: macOS binaries run without Gatekeeper warnings or quarantine removal

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational/US5 (Phase 2)**: Depends on Setup - BLOCKS all other user stories
- **US2 (Phase 3)**: Depends on US5 completion (releases must exist)
- **US6 (Phase 4)**: Depends on US5 completion (checksums come from releases)
- **US3 (Phase 5)**: Depends on US5 completion (Docker builds during release)
- **US1 (Phase 6)**: Depends on US5 completion (Homebrew updated during release)
- **US4 (Phase 7)**: Depends on public repository (external dependency)
- **US7 (Phase 8)**: Depends on US5 completion (release-please triggers GoReleaser)
- **Polish (Phase 9)**: Depends on all user stories being verifiable
- **US8 (Phase 10)**: Depends on US5 completion + Apple Developer credentials

### User Story Dependencies

```
US7 (Release-Please) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US5 (Automated Release) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US2 (Binary Downloads)
                                                                 ‚îÇ
                                                                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US6 (Checksum Verification)
                                                                 ‚îÇ
                                                                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US3 (Docker)
                                                                 ‚îÇ
                                                                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US1 (Homebrew)
                                                                 ‚îÇ
                                                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> US8 (macOS Signing) ‚îÄ‚îÄ> [Apple Developer credentials]

US4 (go install) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> [Requires public repository only]
```

### Within Each Phase

- Configuration files before workflow files
- Local testing before pushing changes
- Workflow must pass before verification tasks

### Parallel Opportunities

**Phase 2 (after T004-T007):**
- T008 (new workflow file) and T009 (adds to existing .goreleaser.yml) can run sequentially; T009 depends on T004-T007 completing first

**Phase 3:**
- T012 and T013 can run in parallel (different platforms)

**Phase 5:**
- T016-T017 (Dockerfile) can run in parallel with T021-T022 (Homebrew tap) if Phase 2 complete

**Phase 8:**
- T030, T031, T032 can all run in parallel (different documentation files)

---

## Parallel Example: Phase 2 Configuration

```bash
# After T004-T007 are complete, these can run in parallel:
Task: "T008 [US5] Create GitHub Actions release workflow at .github/workflows/release.yml"
Task: "T009 [US5] Add shell completion generation hooks to .goreleaser.yml"
```

## Parallel Example: Docker and Homebrew Setup

```bash
# Once Phase 2 is complete, these can start in parallel:
Task: "T016 [US3] Create multi-stage Dockerfile at repository root"
Task: "T021 [US1] Create Homebrew tap repository systmms/homebrew-tap on GitHub"
```

---

## Implementation Strategy

### MVP First (US5 + US2 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational/US5 (Automated Release)
3. Complete Phase 3: US2 (Binary Downloads)
4. **STOP and VALIDATE**: Push test tag, verify binaries appear in GitHub Releases
5. Deploy: This is a usable MVP - users can download binaries!

### Incremental Delivery

1. Setup + US5 (Foundational) ‚Üí Release automation works
2. Add US2 (Binary Downloads) ‚Üí Users can download binaries
3. Add US6 (Checksums) ‚Üí Security verification available
4. Add US3 (Docker) ‚Üí Container users supported
5. Add US1 (Homebrew) ‚Üí macOS developers get best experience
6. Add US4 (go install) ‚Üí Go developers supported
7. Polish ‚Üí Documentation complete

### Suggested MVP Scope

**Minimum viable release**: Phases 1-3 (Setup + US5 + US2)
- Creates releases automatically on tags
- Provides downloadable binaries for all platforms
- Time estimate: 2-4 hours

**Full feature**: All phases (Setup through Polish)
- All distribution methods working
- Time estimate: 4-8 hours

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- US5 is foundational - enables all other distribution methods
- T010 (local GoReleaser test) is critical before pushing workflow
- T023 (PAT creation) requires repository admin access
- T027 (public repo) is an external dependency beyond this spec
- Commit after each task or logical group
- Test locally before pushing workflow changes
