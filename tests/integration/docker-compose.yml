services:
  # HashiCorp Vault - Secret store for integration tests
  vault:
    image: hashicorp/vault:1.15
    ports:
      - "0:8200"  # Dynamic port allocation for parallel test support
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: test-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "sh", "-c", "VAULT_ADDR=http://localhost:8200 vault status"]
      interval: 2s
      timeout: 1s
      retries: 10
      start_period: 5s

  # PostgreSQL - Database for rotation testing
  postgres:
    image: postgres:15-alpine
    ports:
      - "0:5432"  # Dynamic port allocation for parallel test support
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test-password
      POSTGRES_DB: testdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test"]
      interval: 2s
      timeout: 1s
      retries: 10
      start_period: 3s

  # LocalStack - AWS services emulation (Secrets Manager, SSM)
  localstack:
    image: localstack/localstack:latest
    ports:
      - "0:4566"  # Dynamic port allocation for parallel test support
    environment:
      SERVICES: secretsmanager,ssm
      DEBUG: 0
      EAGER_SERVICE_LOADING: 1
    volumes:
      - "./localstack-init:/etc/localstack/init/ready.d"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 2s
      timeout: 1s
      retries: 15
      start_period: 10s

  # MongoDB - NoSQL database for rotation testing
  mongodb:
    image: mongo:7
    ports:
      - "0:27017"  # Dynamic port allocation for parallel test support
    environment:
      MONGO_INITDB_ROOT_USERNAME: test
      MONGO_INITDB_ROOT_PASSWORD: test-password
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 2s
      timeout: 1s
      retries: 10
      start_period: 5s

  # MailHog - SMTP server for email notification testing
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "0:1025"  # SMTP - Dynamic port allocation for parallel test support
      - "0:8025"  # HTTP API - Dynamic port allocation for parallel test support
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 2s
      timeout: 1s
      retries: 10
      start_period: 3s

